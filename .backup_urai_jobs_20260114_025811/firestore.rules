rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --- Helper Functions ---
    function isSignedIn() {
      return request.auth != null;
    }

    function isAdmin() {
      // Check for existence of the user's UID in the admins collection
      return isSignedIn() && exists(/databases/$(database)/documents/admins/$(request.auth.uid));
    }

    function isOwner() {
      return isAdmin() && get(/databases/$(database)/documents/admins/$(request.auth.uid)).data.role == 'owner';
    }

    // --- Collections ---

    // Admins: Only owners can create/update roles. Admins can read.
    match /admins/{uid} {
      allow read: if isAdmin();
      allow write: if isOwner();
    }

    // Jobs: Full access for admins only.
    match /jobs/{jobId} {
      allow read, write: if isAdmin();
    }

    // Public Jobs: Read-only for everyone, only for open jobs.
    match /jobPublic/{jobId} {
      allow write: if false; // Managed by backend function
      allow get: if resource.data.status == 'open';
      allow list: if isAdmin(); // Allow admins to list all for management
    }

    // Applicants: Can be created by anyone. Read/Update only by admins.
    match /applicants/{applicantId} {
      allow create: if request.resource.data.primaryEmail is string;
      allow read, update, delete: if isAdmin();
    }

    // Applications: Can be created by anyone. Read/Update only by admins.
    match /applications/{applicationId} {
      allow create: if request.resource.data.jobId is string && request.resource.data.applicantEmail is string;
      allow read, update, delete: if isAdmin();
    }

    // Waitlist: Public can create, admins can manage.
    match /waitlist/{entryId} {
      allow create: if request.resource.data.email is string;
      allow read, update, delete: if isAdmin();
    }

    // Referrals: Managed by admins.
    match /referrals/{refCode} {
        allow read, write: if isAdmin();
    }

    // Events: Public can create, admins can read.
    match /events/{eventId} {
        allow create: if request.resource.data.type is string;
        allow read: if isAdmin();
    }

    // --- JOB QUEUE (BACKEND ONLY) ---
    match /queues/{queueId}/{taskId} {
      allow read, write: if false; // No client access
    }
    match /dlq/{queueId}/{taskId} {
      allow read, write: if false; // No client access
    }
    match /jobLeases/{taskId} {
      allow read, write: if false; // No client access
    }
    match /jobMetrics/{queueId} {
       allow read, write: if false; // No client access
    }

    // Digests: Read-only for admins
    match /digests/{digestId} {
      allow read: if isAdmin();
      allow write: if false; // Backend only
    }
  }
}
