rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --- Helper Functions ---
    function isSignedIn() {
      return request.auth != null;
    }

    function isAdmin() {
      return isSignedIn() && exists(/databases/$(database)/documents/admins/$(request.auth.uid));
    }

    function isOwner(uid) {
      return request.auth.uid == uid;
    }

    function getRole() {
      return get(/databases/$(database)/documents/admins/$(request.auth.uid)).data.role;
    }

    // --- Collections ---

    // Admins can do anything
    match /{path=**}/documents/{doc} {
        allow read, write: if isAdmin();
    }

    // Public read for open jobs
    match /jobPublic/{jobId} {
      allow get: if true;
      allow list: if false; // No listing all public jobs
    }

    // Allow users to apply for jobs
    match /applications/{applicationId} {
        allow create: if request.resource.data.keys().hasAll(['jobId', 'applicantEmail', 'answers', 'submittedAt']);
    }

    // Allow users to create an applicant profile
    match /applicants/{applicantId} {
        allow create: if request.resource.data.keys().hasAll(['primaryEmail', 'name']);
    }

    // Allow users to join the waitlist
    match /waitlist/{waitlistId} {
        allow create: if request.resource.data.keys().hasAll(['email', 'consent']);
    }

    // Allow anyone to submit events
    match /events/{eventId} {
        allow create: if request.resource.data.keys().hasAll(['type', 'entityType', 'entityId', 'createdAt']);
    }

    // Deny all other access
    match /{path=**}/documents/{doc} {
      allow read, write: if false;
    }
  }
}
