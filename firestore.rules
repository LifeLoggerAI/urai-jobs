rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions
    function isSignedIn() {
      return request.auth != null;
    }

    function isAdmin() {
      return isSignedIn() && get(/databases/$(database)/documents/admins/$(request.auth.uid)).data.role in ['owner', 'admin'];
    }

    function isReviewer() {
        return isSignedIn() && get(/databases/$(database)/documents/admins/$(request.auth.uid)).data.role in ['owner', 'admin', 'reviewer'];
    }

    function isOwner() {
        return isSignedIn() && get(/databases/$(database)/documents/admins/$(request.auth.uid)).data.role == 'owner';
    }

    //
    // Public collections
    //
    match /jobPublic/{jobId} {
      allow get: if true;
      allow list: if true;
      allow write: if false;
    }

    match /waitlist/{waitlistId} {
      allow read: if isReviewer();
      allow create: if request.resource.data.email.matches('^[^@]+@[^@]+\.[^@]+$')
                      && request.resource.data.consent.terms == true
                      && request.resource.data.createdAt == request.time;
      allow update, delete: if false;
    }

    match /events/{eventId} {
      allow read: if isReviewer();
      allow create: if true; // Simple for now, can be tightened
      allow update, delete: if false;
    }


    //
    // Application process (public write, admin read)
    //
    match /applicants/{applicantId} {
      allow read, update, delete: if isReviewer();
      // Allow creation with some basic validation
      allow create: if request.resource.data.primaryEmail.matches('^[^@]+@[^@]+\.[^@]+$')
                      && request.resource.data.name is string
                      && request.resource.data.name.size() < 100
                      && request.resource.data.createdAt == request.time;
    }

    match /applications/{applicationId} {
      allow read, update, delete: if isReviewer();
      allow create: if request.resource.data.jobId is string
                      && request.resource.data.applicantEmail.matches('^[^@]+@[^@]+\.[^@]+$')
                      && request.resource.data.submittedAt == request.time;
    }

    //
    // Admin-only collections
    //
    match /jobs/{jobId} {
      allow read, write: if isAdmin();
    }

    match /referrals/{refCode} {
      allow read, write: if isAdmin();
    }

    match /admins/{uid} {
      allow read: if isReviewer();
      // Only owners can create/update admins, but cannot delete themselves.
      allow write: if isOwner() && request.auth.uid != uid;
      allow create: if isOwner();
    }

    // Default deny all other access
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
