import React, { useState, useEffect } from \'react\';\nimport { useParams, useNavigate } from \'react-router-dom\';\nimport { collection, addDoc, serverTimestamp } from \'firebase/firestore\';\nimport { ref, uploadBytesResumable, getDownloadURL } from \'firebase/storage\';\nimport { db, storage } from \'../firebase\';\n\nconst Apply = () => {\n  const { jobId } = useParams();\n  const navigate = useNavigate();\n  const [form, setForm] = useState({\n    name: \'\',\n    email: \'\',\n    phone: \'\',\n    portfolio: \'\',\n    linkedin: \'\',\n    github: \'\',\n    other: \'\',\n    answers: {},\n  });\n  const [resume, setResume] = useState(null);\n  const [isUploading, setIsUploading] = useState(false);\n  const localStorageKey = `application-draft-${jobId}-${form.email}`;\n\n  useEffect(() => {\n    const draft = localStorage.getItem(localStorageKey);\n    if (draft) {\n      setForm(JSON.parse(draft));\n    }\n  }, [localStorageKey]);\n\n  const handleChange = (e) => {\n    const { name, value } = e.target;\n    const newForm = { ...form, [name]: value };\n    setForm(newForm);\n    localStorage.setItem(localStorageKey, JSON.stringify(newForm));\n  };\n\n  const handleFileChange = (e) => {\n    setResume(e.target.files[0]);\n  };\n\n  const handleSubmit = async (e) => {\n    e.preventDefault();\n    setIsUploading(true);\n\n    try {\n      const applicationRef = await addDoc(collection(db, \'applications\'), {\n        jobId,\n        applicantEmail: form.email.toLowerCase(),\n        ...form,\n        submittedAt: serverTimestamp(),\n        status: \'NEW\',\n      });\n\n      if (resume) {\n        const storageRef = ref(\n          storage,\n          `resumes/${applicationRef.id}/${resume.name}`\n        );\n        const uploadTask = uploadBytesResumable(storageRef, resume);\n\n        uploadTask.on(\n          \'state_changed\',\n          (snapshot) => {\n            // Progress function ...\n          },\n          (error) => {\n            // Error function ...\n            console.log(error);\n          },\n          () => {\n            getDownloadURL(uploadTask.snapshot.ref).then((downloadURL) => {\n              console.log(\'File available at\', downloadURL);\n              // TODO: update application with resume info\n            });\n          }\n        );\n      }\n\n      localStorage.removeItem(localStorageKey);\n      navigate(\'/apply/success\');\n    } catch (error) {\n      console.error(\'Error adding document: \', error);\n    }\ finally {\n      setIsUploading(false);\n    }\n  };\n\n  return (\n    <form onSubmit={handleSubmit}>\n      <input\n        type=\"text\"\n        name=\"name\"\n        placeholder=\"Full Name\"\n        value={form.name}\n        onChange={handleChange}\n        required\n      />\n      <input\n        type=\"email\"\n        name=\"email\"\n        placeholder=\"Email\"\n        value={form.email}\n        onChange={handleChange}\n        required\n      />\n            <input\n        type=\"tel\"\n        name=\"phone\"\n        placeholder=\"Phone (Optional)\"\n        value={form.phone}\n        onChange={handleChange}\n      />\n      <input\n        type=\"url\"\n        name=\"portfolio\"\n        placeholder=\"Portfolio URL\"\n        value={form.portfolio}\n        onChange={handleChange}\n      />\n      <input\n        type=\"url\"\n        name=\"linkedin\"\n        placeholder=\"LinkedIn URL\"\n        value={form.linkedin}\n        onChange={handleChange}\n      />\n      <input\n        type=\"url\"\n        name=\"github\"\n        placeholder=\"GitHub URL\"\n        value={form.github}\n        onChange={handleChange}\n      />\n      <input\n        type=\"text\"\n        name=\"other\"\n        placeholder=\"Other Links\"\n        value={form.other}\n        onChange={handleChange}\n      />\n      <input type=\"file\" onChange={handleFileChange} />\n      <button type=\"submit\" disabled={isUploading}>\n        {isUploading ? \'Submitting...\' : \'Submit Application\'}\n      </button>\n    </form>\n  );\n};\n\nexport default Apply;\n